<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’ã„ç‰ã®å†’é™º with Ranking</title>
    <style>
        body { margin: 0; background: #f0f0f0; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden;}
        
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šå·¦ãŒã‚²ãƒ¼ãƒ ã€å³ãŒãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        #game-area { flex: 3; position: relative; background: #222; display: flex; justify-content: center; align-items: center; }
        #sidebar { flex: 1; background: #333; color: white; padding: 20px; box-shadow: -2px 0 5px rgba(0,0,0,0.5); overflow-y: auto; z-index: 10; min-width: 250px;}

        canvas { background: #111; box-shadow: 0 0 20px rgba(0,0,0,0.5); max-width: 100%; max-height: 100%; }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        h2 { border-bottom: 2px solid #00d2ff; padding-bottom: 5px; margin-top: 0; }
        ol { padding-left: 20px; }
        li { margin-bottom: 8px; font-size: 16px; border-bottom: 1px solid #444; padding: 5px 0; display: flex; justify-content: space-between; }
        .rank-score { color: #00d2ff; font-weight: bold; }

        /* åå‰å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆTop10å…¥ã‚Šã®æ™‚ã ã‘è¡¨ç¤ºï¼‰ */
        #input-form { display: none; background: #444; padding: 15px; border-radius: 5px; margin-top: 20px; border: 1px solid #00d2ff; }
        input { width: 90%; padding: 8px; margin-bottom: 10px; border: none; border-radius: 3px; }
        button { width: 100%; padding: 10px; background: #00d2ff; border: none; color: #222; font-weight: bold; cursor: pointer; border-radius: 3px; }
        button:hover { background: #00b0d9; }
        
        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #game-area { flex: 2; }
            #sidebar { flex: 1; min-height: 200px; }
        }
    </style>
</head>
<body>

    <div id="game-area">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="sidebar">
        <h2>ğŸ† TOP 10 Ranking</h2>
        <div id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        <ol id="ranking-list"></ol>

        <div id="input-form">
            <h3>ğŸ‰ Top 10å…¥ã‚Šï¼</h3>
            <p>ã‚¹ã‚³ã‚¢: <span id="final-score"></span></p>
            <input type="text" id="player-name" placeholder="åå‰ã‚’å…¥åŠ› (8æ–‡å­—ä»¥å†…)" maxlength="8">
            <button onclick="submitScore()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²</button>
        </div>
        
        <div style="margin-top: 30px; font-size: 12px; color: #aaa;">
            <p>ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã¾ãŸã¯ã‚¿ãƒƒãƒ—ã§ãƒªãƒˆãƒ©ã‚¤</p>
        </div>
    </div>

    <script>
        // â–¼â–¼ ã“ã“ã«ã‚³ãƒ”ãƒ¼ã—ãŸGASã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â–¼â–¼
        const GAS_URL = "https://script.google.com/macros/library/d/1-WoGA_rb_i1cr6SGLIrax02xmD4-zb3tZqMH5S9fq7klpkCCAEDAlh3O/1"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // ç”»é¢ã‚µã‚¤ã‚ºèª¿æ•´
        function resize() {
            const container = document.getElementById('game-area');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // ã‚²ãƒ¼ãƒ å¤‰æ•°
        let score = 0;
        let gameOver = false;
        let isRankIn = false;
        const player = { x: canvas.width / 2, y: canvas.height - 50, size: 15, color: '#00d2ff' };
        let enemies = [];
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿
        let currentRanking = [];

        // æ“ä½œ
        function movePlayer(e) {
            if(gameOver) return;
            const rect = canvas.getBoundingClientRect();
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            player.x = clientX - rect.left;
        }
        canvas.addEventListener('mousemove', movePlayer);
        canvas.addEventListener('touchmove', movePlayer, { passive: false });
        
        // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ï¼‰
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && gameOver && !isRankIn) resetGame();
        });
        canvas.addEventListener('click', () => {
            if (gameOver && !isRankIn) resetGame();
        });

        function resetGame() {
            score = 0;
            enemies = [];
            gameOver = false;
            isRankIn = false;
            document.getElementById('input-form').style.display = 'none';
            update();
        }

        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function update() {
            if (gameOver) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
            ctx.fill();

            // æ•µ
            if (Math.random() < 0.05) enemies.push({ x: Math.random() * canvas.width, y: -20 });

            ctx.fillStyle = '#ff4757';
            for (let i = 0; i < enemies.length; i++) {
                enemies[i].y += 5;
                ctx.beginPath();
                ctx.arc(enemies[i].x, enemies[i].y, 10, 0, Math.PI * 2);
                ctx.fill();

                // è¡çªåˆ¤å®š
                const dx = player.x - enemies[i].x;
                const dy = player.y - enemies[i].y;
                if (Math.sqrt(dx*dx + dy*dy) < 25) {
                    endGame();
                }
            }
            score++;
            
            // ã‚¹ã‚³ã‚¢è¡¨ç¤º
            ctx.fillStyle = "white";
            ctx.font = "20px Arial";
            ctx.textAlign = "left";
            ctx.fillText("Score: " + score, 20, 40);

            requestAnimationFrame(update);
        }

        function endGame() {
            gameOver = true;
            ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2);

            checkRankIn();
        }

        // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  ---

        // 1. ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿
        async function fetchRanking() {
            document.getElementById('loading').style.display = 'block';
            try {
                const res = await fetch(GAS_URL + "?action=get");
                const data = await res.json();
                currentRanking = data;
                renderRanking(data);
            } catch (e) {
                console.error("ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—å¤±æ•—", e);
                document.getElementById('ranking-list').innerHTML = "<li>å–å¾—ã‚¨ãƒ©ãƒ¼</li>";
            }
            document.getElementById('loading').style.display = 'none';
        }

        // 2. ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
        function renderRanking(data) {
            const list = document.getElementById('ranking-list');
            list.innerHTML = "";
            data.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${escapeHtml(item.name)}</span> <span class="rank-score">${item.score}</span>`;
                list.appendChild(li);
            });
        }

        // 3. ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³åˆ¤å®š
        function checkRankIn() {
            // 10ä½ä»¥å†…ã®ã‚¹ã‚³ã‚¢ã‹ã€ã¾ã 10äººã„ãªã„å ´åˆ
            const lowestScore = currentRanking.length < 10 ? 0 : currentRanking[currentRanking.length - 1].score;
            
            if (score > lowestScore || currentRanking.length < 10) {
                isRankIn = true;
                document.getElementById('input-form').style.display = 'block';
                document.getElementById('final-score').innerText = score;
            }
        }

        // 4. ã‚¹ã‚³ã‚¢é€ä¿¡
        async function submitScore() {
            const name = document.getElementById('player-name').value || "åç„¡ã—";
            const btn = document.querySelector('button');
            btn.disabled = true;
            btn.innerText = "é€ä¿¡ä¸­...";

            try {
                // GASã«é€ä¿¡
                await fetch(`${GAS_URL}?action=add&name=${encodeURIComponent(name)}&score=${score}`);
                
                // é€ä¿¡å¾Œã«æœ€æ–°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å†å–å¾—
                await fetchRanking();
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã—ã¦ãƒªã‚»ãƒƒãƒˆå¾…æ©Ÿ
                document.getElementById('input-form').style.display = 'none';
                isRankIn = false;
                alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
            } catch (e) {
                alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼");
            } finally {
                btn.disabled = false;
                btn.innerText = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²";
            }
        }

        function escapeHtml(str) {
            if(!str) return str;
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[m];
            });
        }

        // åˆå›èª­ã¿è¾¼ã¿
        fetchRanking();
        update();
    </script>
</body>
</html>

